name: publish-python-package

on:
  push:
    tags:
       - 'v*'

jobs:

  publish_pypi_linux:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        architecture: [ "x86_64", "aarch64" ]
    continue-on-error: true
    steps:
      - uses: actions/checkout@v2
        with:
          submodules: true
      - uses: docker/setup-qemu-action@v1
        with:
          platforms: linux/${{ matrix.architecture }}
        if: matrix.architecture != 'x86_64'
      - run: sed 's/%arch%/${{ matrix.architecture }}/g' .github/workflows/manylinux_build.sh > .github/workflows/manylinux_build_script.sh
      - run: docker run -v "$(pwd)":/workdir --platform linux/${{ matrix.architecture }} quay.io/pypa/manylinux2014_${{ matrix.architecture }} /bin/bash /workdir/.github/workflows/manylinux_build_script.sh
      - uses: pypa/gh-action-pypi-publish@release/v1
        with:
          user: ${{ secrets.PYPI_USER }}
          password: ${{ secrets.PYPI_PASS }}
          packages_dir: target/wheels
      - uses: softprops/action-gh-release@v1
        with:
          files: target/wheels/*

  publish_pypi_mac:
    runs-on: macos-latest
    env:
      DEVELOPER_DIR: '/Applications/Xcode.app/Contents/Developer'
      SDKROOT: '/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk'
      MACOSX_DEPLOYMENT_TARGET: '10.14'
    steps:
      - uses: actions/checkout@v2
        with:
          submodules: true
      - uses: actions/setup-python@v2
        with:
          python-version: 3.7
      - run: rustup update && rustup target add aarch64-apple-darwin
      - run: pip install maturin
      - run: maturin publish --no-sdist --universal2 -m Cargo.toml -u ${{ secrets.PYPI_USER }} -p ${{ secrets.PYPI_PASS }}
      - run: maturin publish --no-sdist -m Cargo.toml -u ${{ secrets.PYPI_USER }} -p ${{ secrets.PYPI_PASS }}
      - uses: softprops/action-gh-release@v1
        with:
          files: target/wheels/*

  publish_pypi_windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v2
        with:
          submodules: true
      - uses: actions/setup-python@v2
        with:
          python-version: 3.7
      - run: rustup update
      - run: pip install maturin
      - run: Remove-Item -LiteralPath "C:\msys64\" -Force -Recurse
      - run: maturin publish --no-sdist -m Cargo.toml -u ${{ secrets.PYPI_USER }} -p ${{ secrets.PYPI_PASS }}
      - uses: softprops/action-gh-release@v1
        with:
          files: target/wheels/*

  publish_pypi_stdist:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          submodules: true
      - run: pip install maturin
      - run: maturin sdist -m Cargo.toml
      - uses: pypa/gh-action-pypi-publish@release/v1
        with:
          user: ${{ secrets.PYPI_USER }}
          password: ${{ secrets.PYPI_PASS }}
          packages_dir: target/wheels
      - uses: softprops/action-gh-release@v1
        with:
          files: target/wheels/*
